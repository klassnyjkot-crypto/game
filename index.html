<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Mini Flappy — Textures</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    html,body { margin:0; padding:0; height:100%; background:#87ceeb; }
    canvas { display:block; margin:0 auto; background:linear-gradient(#87ceeb,#bfefff); }
    #overlay { position:fixed; left:10px; top:10px; font-family:sans-serif; color:#fff; font-weight:700; text-shadow:0 1px 0 #000; }
    #btn { position:fixed; right:10px; top:10px; padding:6px 10px; background:#222; color:#fff; border-radius:6px; cursor:pointer; }
    #loading { position:fixed; left:50%; top:50%; transform:translate(-50%,-50%); color:#fff; font-family:sans-serif; font-weight:700; text-shadow:0 1px 0 #000; }
  </style>
</head>
<body>
  <div id="overlay">Score: <span id="score">0</span></div>
  <div id="btn">Tap / Click</div>
  <div id="loading">Загрузка текстур...</div>
  <canvas id="c"></canvas>

<script>
/* --- URL сервера для отправки очков --- */
const SCORE_POST_URL = 'https://tg-game-bot-o4sx.onrender.com/score'; // <- замени на свой Render URL
/* ------------------------------------ */

function getQueryParam(name) {
  const q = (location.search ? location.search : location.hash.split('?').slice(1).join('?'));
  if (!q) return null;
  const params = new URLSearchParams(q);
  return params.get(name);
}
const TOKEN = getQueryParam('token') || '';

const IMG_PATHS = {
  bird: 'bird.png',
  pipe: 'pipe.png',
  bg:   'bg.png',
  ground: 'ground.png'
};

const IMGS = { bird: null, pipe: null, bg: null, ground: null };
let imagesReady = false;

function preloadImages() {
  const keys = Object.keys(IMG_PATHS);
  let loaded = 0;
  if (keys.length === 0) { imagesReady = true; document.getElementById('loading').style.display='none'; return; }
  for (const k of keys) {
    const path = IMG_PATHS[k];
    if (!path) { loaded++; if (loaded === keys.length) { imagesReady = true; document.getElementById('loading').style.display='none'; } continue; }
    const img = new Image();
    img.crossOrigin = 'anonymous';
    img.onload = () => { IMGS[k] = img; loaded++; if (loaded === keys.length) { imagesReady = true; document.getElementById('loading').style.display='none'; } };
    img.onerror = () => { console.warn('Не удалось загрузить:', path); IMGS[k] = null; loaded++; if (loaded === keys.length) { imagesReady = true; document.getElementById('loading').style.display='none'; } };
    img.src = path;
  }
}

const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d');
function fit() {
  canvas.width = Math.min(window.innerWidth, 600);
  canvas.height = Math.min(window.innerHeight-40, 800);
}
fit(); window.addEventListener('resize', fit);

let bird = { x:80, y:150, vy:0, w:28, h:28 };
let pipes = [];
let frame = 0;
let score = 0;
let alive = true;
const GRAV = 0.45;
const FLAP = -8;
const PIPE_W = 50;

document.getElementById('btn').addEventListener('click', () => flap());
document.addEventListener('keydown', e => { if (e.code==='Space') flap(); });
canvas.addEventListener('touchstart', e => { e.preventDefault(); flap(); }, {passive:false});
function flap(){ if (!alive) reset(); bird.vy = FLAP; }

function spawnPipe() {
  const gap = 120;
  const minY = 60, maxY = canvas.height - 60 - gap;
  const y = Math.floor(Math.random()*(maxY-minY))+minY;
  pipes.push({x:canvas.width, yTop: y, gap});
}

function update(){
  if (alive) {
    frame++;
    if (frame%90===0) spawnPipe();
    bird.vy += GRAV;
    bird.y += bird.vy;
    for (let p of pipes) p.x -= 3 + Math.min(3, Math.floor(score/10));
    if (pipes.length && pipes[0].x < -60) { pipes.shift(); score++; }
    for (let p of pipes) {
      if (bird.x + bird.w > p.x && bird.x < p.x + PIPE_W) {
        if (bird.y < p.yTop || bird.y + bird.h > p.yTop + p.gap) die();
      }
    }
    if (bird.y > canvas.height || bird.y < -50) die();
  }
}

function die(){
  if (!alive) return;
  alive = false;
  sendScore(score);
}

function drawBackground() {
  if (imagesReady && IMGS.bg) {
    ctx.drawImage(IMGS.bg, 0, 0, canvas.width, canvas.height);
  } else {
    const g = ctx.createLinearGradient(0,0,0,canvas.height);
    g.addColorStop(0, '#87ceeb');
    g.addColorStop(1, '#bfefff');
    ctx.fillStyle = g;
    ctx.fillRect(0,0,canvas.width,canvas.height);
  }
}

function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  drawBackground();

  if (imagesReady && IMGS.ground) {
    ctx.drawImage(IMGS.ground, 0, canvas.height-40, canvas.width, 40);
  } else {
    ctx.fillStyle='#4da64d';
    ctx.fillRect(0, canvas.height-40, canvas.width, 40);
  }

  for (let p of pipes) {
    if (imagesReady && IMGS.pipe) {
      ctx.save();
      ctx.translate(p.x + PIPE_W/2, p.yTop);
      ctx.scale(1, -1);
      ctx.drawImage(IMGS.pipe, -PIPE_W/2, 0, PIPE_W, canvas.height);
      ctx.restore();
      ctx.drawImage(IMGS.pipe, p.x, p.yTop + p.gap, PIPE_W, canvas.height - (p.yTop + p.gap) - 40);
    } else {
      ctx.fillStyle = '#1d7a1d';
      ctx.fillRect(p.x, 0, PIPE_W, p.yTop);
      ctx.fillRect(p.x, p.yTop + p.gap, PIPE_W, canvas.height - (p.yTop + p.gap) - 40);
    }
  }

  if (imagesReady && IMGS.bird) {
    ctx.drawImage(IMGS.bird, bird.x, bird.y, bird.w, bird.h);
  } else {
    ctx.fillStyle = '#ffcc00';
    ctx.fillRect(bird.x, bird.y, bird.w, bird.h);
  }

  document.getElementById('score').innerText = score;

  if (!alive) {
    ctx.fillStyle = 'rgba(0,0,0,0.6)';
    ctx.fillRect(0,0,canvas.width,canvas.height);

    // --- НОВЫЙ БЛОК НАДПИСИ ---
    ctx.fillStyle = 'red';
    ctx.font = 'bold 48px sans-serif';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText('GAME OVER', canvas.width / 2, canvas.height / 2 - 30);

    ctx.fillStyle = '#fff';
    ctx.font = '20px sans-serif';
    ctx.fillText('Tap / Click to play again', canvas.width / 2, canvas.height / 2 + 20);
    // -------------------------
  }
}

function loop(){ update(); draw(); requestAnimationFrame(loop); }

function reset(){ bird = { x:80, y:150, vy:0, w:28, h:28 }; pipes=[]; frame=0; score=0; alive=true; }

preloadImages();
loop();

async function sendScore(s) {
  try {
    await fetch(SCORE_POST_URL, {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify({ token: TOKEN, score: s })
    });
  } catch (e) {
    console.warn('Не удалось отправить очки', e);
  }
}
</script>
</body>
</html>
