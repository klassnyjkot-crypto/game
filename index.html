<script>
/* --- Настройки: укажи сюда URL сервера (Replit) после деплоя --- */
const SCORE_POST_URL = 'https://tg-game-bot-o4sx.onrender.com/score'; // <- поменяй на свой Replit URL
/* ------------------------------------------------------------ */

function getQueryParam(name) {
  const q = (location.search ? location.search : location.hash.split('?').slice(1).join('?'));
  if (!q) return null;
  const params = new URLSearchParams(q);
  return params.get(name);
}
const TOKEN = getQueryParam('token') || '';

const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d');
function fit() {
  canvas.width = Math.min(window.innerWidth, 600);
  canvas.height = Math.min(window.innerHeight-40, 800);
}
fit(); window.addEventListener('resize', fit);

let bird = { x:80, y:150, vy:0, w:20, h:16 };
let pipes = [];
let frame = 0;
let score = 0;
let alive = true;
const GRAV = 0.45;
const FLAP = -8;

document.getElementById('btn').addEventListener('click', () => flap());
document.addEventListener('keydown', e => { if (e.code==='Space') flap(); });
canvas.addEventListener('touchstart', e => { e.preventDefault(); flap(); }, {passive:false});

function flap(){ 
  if (!alive) reset(); 
  bird.vy = FLAP; 
}

function spawnPipe() {
  const gap = 120;
  const minY = 60, maxY = canvas.height - 60 - gap;
  const y = Math.floor(Math.random()*(maxY-minY))+minY;
  pipes.push({x:canvas.width, yTop: y, gap});
}

function update(){
  if (!alive) return; // <-- остановка игры после смерти

  frame++;
  if (frame%90===0) spawnPipe();

  bird.vy += GRAV;
  bird.y += bird.vy;

  // движение труб
  for (let p of pipes) p.x -= 3 + Math.min(3, Math.floor(score/10));

  // удаляем трубы и увеличиваем счёт
  if (pipes.length && pipes[0].x < -60) {
    pipes.shift();
    score++;
  }

  // коллизии
  for (let p of pipes) {
    if (bird.x + bird.w > p.x && bird.x < p.x + 50) {
      if (bird.y < p.yTop || bird.y + bird.h > p.yTop + p.gap) die();
    }
  }

  if (bird.y > canvas.height || bird.y < -50) die();
}

function die(){
  if (!alive) return;
  alive = false;
  sendScore(score);
}

function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // фон
  ctx.fillStyle='#4da64d';
  ctx.fillRect(0, canvas.height-40, canvas.width, 40);

  // трубы
  for (let p of pipes) {
    ctx.fillStyle = '#1d7a1d';
    ctx.fillRect(p.x, 0, 50, p.yTop);
    ctx.fillRect(p.x, p.yTop + p.gap, 50, canvas.height - (p.yTop + p.gap) - 40);
  }

  // птица
  ctx.fillStyle = '#ffcc00';
  ctx.fillRect(bird.x, bird.y, bird.w, bird.h);

  document.getElementById('score').innerText = score;

  if (!alive) {
    ctx.fillStyle = 'rgba(0,0,0,0.6)';
    ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle = '#fff';
    ctx.font = '20px sans-serif';
    ctx.fillText('Game over — tap to play again', 20, canvas.height/2);
  }
}

function loop(){ 
  update(); 
  draw(); 
  requestAnimationFrame(loop); 
}

function reset(){ 
  bird = { x:80, y:150, vy:0, w:20, h:16 }; 
  pipes = []; 
  frame=0; 
  score=0; 
  alive=true; 
}

loop();

async function sendScore(s) {
  try {
    await fetch(SCORE_POST_URL, {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify({
